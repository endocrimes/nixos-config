name: "Build System Configurations"
on:
  pull_request:
  push:
    branches:
      - main
jobs:
  build-mir:
    runs-on: flake
    steps:
    - uses: actions/checkout@v3
    - name: Setup Attic cache
      uses: ryanccn/attic-action@v0
      with:
        endpoint: ${{ secrets.ATTIC_ENDPOINT }}
        cache: ${{ secrets.ATTIC_CACHE }}
        token: ${{ secrets.ATTIC_TOKEN }}
    - run: nix build .#nixosConfigurations.mir.config.system.build.toplevel
    - run: nix flake check

  build-saturnv:
    runs-on: flake
    steps:
    - uses: actions/checkout@v3
    - name: Setup Attic cache
      uses: ryanccn/attic-action@v0
      with:
        endpoint: ${{ secrets.ATTIC_ENDPOINT }}
        cache: ${{ secrets.ATTIC_CACHE }}
        token: ${{ secrets.ATTIC_TOKEN }}
    - run: nix build .#nixosConfigurations.saturnv.config.system.build.toplevel
    - run: nix flake check

  build-home-x86_64linux:
    runs-on: flake
    steps:
    - uses: actions/checkout@v3
    - name: Setup Attic cache
      uses: ryanccn/attic-action@v0
      with:
        endpoint: ${{ secrets.ATTIC_ENDPOINT }}
        cache: ${{ secrets.ATTIC_CACHE }}
        token: ${{ secrets.ATTIC_TOKEN }}
    - run: nix build .#homeConfigurations.x86_64-linux.danielle_nogui.activationPackage

  sync_to_github:
    runs-on: ubuntu-latest
    if: gitea.event_name == 'push'
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.REPO_SYNC_KEY }}
    - name: update known_hosts
      run: ssh-keyscan -H github.com >> ~/.ssh/known_hosts
    - run: git remote add github git@github.com:endocrimes/nixos-config.git
    - run: git fetch github main
    - run: git push github main

